# A workflow supposed to run when there is a new release of Next.js.
# This relies on next.js upstream's `repository_dispatch` workflow.
name: Next.js Release Publish

on:
  repository_dispatch:
    # This is the event type defined by next.js upstream's `repository_dispatch` workflow dispatches.
    types: [nextjs-release-published]
  workflow_dispatch:

jobs:
  # Debug purpose, write down release version.
  check-release-tag:
    name: Check latest release
    runs-on: ubuntu-latest
    steps:
      - name: Print release tag
        run: echo "Found a new release ${{ github.event.client_payload.version }}"

  # Trigger actual next.js integration tests.
  next_js_integration:
    name: Execute Next.js integration workflow
    permissions:
      pull-requests: write
    uses: ./.github/workflows/nextjs-integration-test.yml
    with:
    version: ${{ github.event.client_payload.version }}

  # Upload test results to branch.
  upload_test_results:
    name: Upload test results
    needs: [next_js_integration]
    uses: ./.github/workflows/upload-nextjs-integration-test-results.yml
    with:
      is_main_branch: false
